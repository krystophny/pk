#!/bin/sh
# pk-check - check for untracked system files (recursive)
# Usage: pk check [dir...]
# Default: checks /usr/bin /usr/sbin /usr/lib

SCRIPT_DIR="$(dirname "$0")"
. "$SCRIPT_DIR/pk-common"

# Default directories to check
if [ $# -eq 0 ]; then
    set -- /usr/bin /usr/sbin /usr/lib
fi

# Get tracked files
tracked_file=$(mktemp)
untracked_file=$(mktemp)
get_tracked_files > "$tracked_file"

for dir in "$@"; do
    [ -d "$dir" ] || continue
    # Recursive find of all files (not directories)
    find "$dir" -type f 2>/dev/null | while read -r f; do
        if ! grep -qxF "$f" "$tracked_file"; then
            echo "$f" >> "$untracked_file"
        fi
    done
done

if [ -s "$untracked_file" ]; then
    cat "$untracked_file"
    count=$(wc -l < "$untracked_file")
    rm -f "$tracked_file" "$untracked_file"
    warn "$count untracked files found"
    exit 1
fi

rm -f "$tracked_file" "$untracked_file"
info "all files tracked"
