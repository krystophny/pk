#!/bin/sh
# pk-download - download package source
# Usage: pk download <pkgname>

SCRIPT_DIR="$(dirname "$0")"
. "$SCRIPT_DIR/pk-common"

[ $# -ge 1 ] || die "usage: pk download <pkgname>"

pkgname="$1"

# Find packages directory
PACKAGES_DIR=""
for d in "./packages" "$SCRIPT_DIR/../packages" "/etc/pk/packages"; do
    [ -d "$d" ] && PACKAGES_DIR="$(cd "$d" && pwd)" && break
done
[ -n "$PACKAGES_DIR" ] || die "packages directory not found"

# Cat all package files
cat_packages() {
    cat "$PACKAGES_DIR"/*.toml
}

# Extract field from TOML
extract_field() {
    local pkg="$1" field="$2"
    cat_packages | awk -v pkg="$pkg" -v field="$field" '
        /^\[packages\./ { in_pkg = ($0 ~ "\\[packages\\." pkg "\\]") }
        in_pkg && $1 == field { gsub(/^[^=]+=[ \t]*"?|"[ \t]*$/, ""); print; exit }
    '
}

version=$(extract_field "$pkgname" "version")
[ -n "$version" ] || die "package '$pkgname' not found"

url=$(extract_field "$pkgname" "url")
[ -n "$url" ] || die "no url for $pkgname"

# Expand variables in URL
version_mm=$(echo "$version" | sed 's/\.[^.]*$//')
url=$(echo "$url" | sed "s|\${version}|$version|g; s|\${version_mm}|$version_mm|g")

# Determine filename
filename="${url##*/}"
destfile="$SOURCES_DIR/$filename"

mkdir -p "$SOURCES_DIR"

if [ -f "$destfile" ]; then
    info "$filename already exists"
else
    info "downloading $url"
    curl -L -o "$destfile" "$url" || die "download failed"
fi

# Extract if archive
case "$filename" in
    *.tar.gz|*.tgz|*.tar.xz|*.tar.bz2)
        srcdir="$SOURCES_DIR/${pkgname}-${version}"
        if [ ! -d "$srcdir" ]; then
            info "extracting to $srcdir"
            cd "$SOURCES_DIR"
            tar xf "$filename"
        fi
        ;;
esac

info "source ready: $destfile"
