#!/bin/sh
# pk-download - download package source
# Usage: pk download <pkgname>

SCRIPT_DIR="$(dirname "$0")"
. "$SCRIPT_DIR/pk-common"

[ $# -ge 1 ] || die "usage: pk download <pkgname>"

pkgname="$1"

# Get package metadata (using pk-common functions)
version=$(get_pkg_version "$pkgname")
[ -n "$version" ] || die "package '$pkgname' not found"

mkdir -p "$SOURCES_DIR"

# Check if using git
use_git=$(extract_field "$pkgname" "use_git")
if [ "$use_git" = "true" ]; then
    git_url=$(extract_field "$pkgname" "git_url")
    [ -n "$git_url" ] || die "no git_url for $pkgname"

    srcdir="$SOURCES_DIR/${pkgname}-${version}"

    # Configure git SSL cert path
    export GIT_SSL_CAINFO=/etc/ssl/certs/ca-certificates.crt

    if [ -d "$srcdir" ]; then
        info "git repo already exists: $srcdir"
        # Update existing repo
        cd "$srcdir"
        git fetch origin 2>/dev/null || true
        git reset --hard origin/HEAD 2>/dev/null || git reset --hard HEAD
    else
        info "cloning $git_url"
        git clone --depth 1 "$git_url" "$srcdir" || die "git clone failed"
    fi

    info "source ready: $srcdir"
    exit 0
fi

# Standard URL download
url=$(extract_field "$pkgname" "url")
[ -n "$url" ] || die "no url for $pkgname"

# Expand variables in URL
version_mm=$(echo "$version" | sed 's/\.[^.]*$//')
url=$(echo "$url" | sed "s|\${version}|$version|g; s|\${version_mm}|$version_mm|g")

# Check for custom tarball name
tarball=$(extract_field "$pkgname" "tarball")
if [ -n "$tarball" ]; then
    tarball=$(echo "$tarball" | sed "s|\${version}|$version|g")
    filename="$tarball"
else
    filename="${url##*/}"
fi
destfile="$SOURCES_DIR/$filename"

if [ -f "$destfile" ]; then
    info "$filename already exists"
else
    info "downloading $url"
    curl -L -o "$destfile" "$url" || die "download failed"
fi

# Get custom source_dir if specified
source_dir=$(extract_field "$pkgname" "source_dir")
if [ -n "$source_dir" ]; then
    source_dir=$(echo "$source_dir" | sed "s|\${version}|$version|g")
    srcdir="$SOURCES_DIR/$source_dir"
else
    srcdir="$SOURCES_DIR/${pkgname}-${version}"
fi

# Extract if archive
case "$filename" in
    *.tar.gz|*.tgz|*.tar.xz|*.tar.bz2)
        if [ ! -d "$srcdir" ]; then
            info "extracting to $srcdir"
            cd "$SOURCES_DIR"
            tar xf "$filename"
        fi
        ;;
esac

# Download extra sources if specified
extra_sources=$(extract_array "$pkgname" "extra_sources")
if [ -n "$extra_sources" ]; then
    echo "$extra_sources" | while IFS= read -r extra_url; do
        [ -n "$extra_url" ] || continue
        extra_url=$(echo "$extra_url" | sed "s|\${version}|$version|g; s|\${version_mm}|$version_mm|g")
        extra_filename="${extra_url##*/}"
        extra_destfile="$SOURCES_DIR/$extra_filename"
        if [ -f "$extra_destfile" ]; then
            info "extra source $extra_filename already exists"
        else
            info "downloading extra source: $extra_url"
            curl -L -o "$extra_destfile" "$extra_url" || die "download failed: $extra_url"
        fi
    done
fi

info "source ready: $destfile"
