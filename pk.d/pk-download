#!/bin/sh
# pk-download - download package source
# Usage: pk download <pkgname>

SCRIPT_DIR="$(dirname "$0")"
. "$SCRIPT_DIR/pk-common"

[ $# -ge 1 ] || die "usage: pk download <pkgname>"

pkgname="$1"

# Find packages.toml
TOML_FILE=""
for f in "./packages.toml" "$SCRIPT_DIR/../packages.toml" "/etc/pk/packages.toml"; do
    [ -f "$f" ] && TOML_FILE="$(cd "$(dirname "$f")" && pwd)/$(basename "$f")" && break
done
[ -n "$TOML_FILE" ] || die "packages.toml not found"

# Extract field from TOML
extract_field() {
    local pkg="$1" field="$2"
    awk -v pkg="$pkg" -v field="$field" '
        /^\[packages\./ { in_pkg = ($0 ~ "\\[packages\\." pkg "\\]") }
        in_pkg && $1 == field { gsub(/^[^=]+=[ \t]*"?|"[ \t]*$/, ""); print; exit }
    ' "$TOML_FILE"
}

version=$(extract_field "$pkgname" "version")
[ -n "$version" ] || die "package '$pkgname' not found in $TOML_FILE"

url=$(extract_field "$pkgname" "url")
[ -n "$url" ] || die "no url for $pkgname"

# Expand variables in URL
version_mm=$(echo "$version" | sed 's/\.[^.]*$//')
url=$(echo "$url" | sed "s|\${version}|$version|g; s|\${version_mm}|$version_mm|g")

# Determine filename
filename="${url##*/}"
destfile="$SOURCES_DIR/$filename"

mkdir -p "$SOURCES_DIR"

if [ -f "$destfile" ]; then
    info "$filename already exists"
else
    info "downloading $url"
    curl -L -o "$destfile" "$url" || die "download failed"
fi

# Extract if archive
case "$filename" in
    *.tar.gz|*.tgz|*.tar.xz|*.tar.bz2)
        srcdir="$SOURCES_DIR/${pkgname}-${version}"
        if [ ! -d "$srcdir" ]; then
            info "extracting to $srcdir"
            cd "$SOURCES_DIR"
            tar xf "$filename"
        fi
        ;;
esac

info "source ready: $destfile"
