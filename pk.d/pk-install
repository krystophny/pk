#!/bin/sh
# pk-install - install a package archive or build from name
# Usage: pk install <pkg.tar.xz> or pk install <pkgname>

SCRIPT_DIR="$(dirname "$0")"
. "$SCRIPT_DIR/pk-common"

safety_check

[ $# -ge 1 ] || die "usage: pk install <pkg.tar.xz|pkgname>"

archive="$1"

# If not a file, assume it's a package name - download, build, install
if [ ! -f "$archive" ]; then
    pkgname="$1"
    info "package file not found, building $pkgname from source..."

    # Download source
    "$SCRIPT_DIR/pk-download" "$pkgname" || die "download failed"

    # Build package
    archive=$("$SCRIPT_DIR/pk-build" "$pkgname") || die "build failed"

    # archive now contains the path to the built package
    [ -f "$archive" ] || die "build did not produce package: $archive"
fi

set -- $(parse_pkgname "$archive")
pkgname="$1"
version="$2"
[ -n "$pkgname" ] || die "cannot parse package name"

dbdir="$DB_DIR/$pkgname"
mkdir -p "$dbdir"

# Extract to PK_ROOT (defaults to / in pk-common)
root="$PK_ROOT"

# List files in archive
tar -tf "$archive" > "$dbdir/files"

# Extract archive (--no-overwrite-dir prevents changing permissions on existing dirs like /)
tar -xf "$archive" -C "$root" --no-overwrite-dir

# Record package info
printf '%s\n%s\n' "$pkgname" "$version" > "$dbdir/info"

# Post-install hooks - regenerate caches if relevant files were installed
run_if_installed() {
    cmd="$1"
    shift
    if command -v "$cmd" >/dev/null 2>&1; then
        "$cmd" "$@" 2>/dev/null || true
    fi
}

# Check what was installed and run appropriate hooks
if grep -q "usr/share/mime/" "$dbdir/files" 2>/dev/null; then
    run_if_installed update-mime-database "${root}usr/share/mime"
fi

if grep -q "usr/lib/gdk-pixbuf-2.0/" "$dbdir/files" 2>/dev/null; then
    run_if_installed gdk-pixbuf-query-loaders --update-cache
fi

if grep -q "usr/lib/gio/modules/" "$dbdir/files" 2>/dev/null; then
    run_if_installed gio-querymodules "${root}usr/lib/gio/modules"
fi

if grep -q "usr/share/icons/" "$dbdir/files" 2>/dev/null; then
    for dir in "${root}usr/share/icons"/*/; do
        [ -d "$dir" ] && run_if_installed gtk-update-icon-cache -q "$dir"
    done
fi

if grep -q "usr/share/applications/.*\.desktop" "$dbdir/files" 2>/dev/null; then
    run_if_installed update-desktop-database -q "${root}usr/share/applications"
fi

if grep -q "usr/share/fonts/" "$dbdir/files" 2>/dev/null; then
    run_if_installed fc-cache -f
fi

if grep -q "usr/share/glib-2.0/schemas/.*\.xml" "$dbdir/files" 2>/dev/null; then
    run_if_installed glib-compile-schemas "${root}usr/share/glib-2.0/schemas"
fi

if grep -q "usr/lib/gtk-3.0/.*/immodules/" "$dbdir/files" 2>/dev/null; then
    for dir in "${root}usr/lib/gtk-3.0"/*/immodules/; do
        [ -d "$dir" ] && run_if_installed gio-querymodules "$dir"
    done
fi

# Run ldconfig if any shared libraries were installed
if grep -qE "usr/lib/.*\.so" "$dbdir/files" 2>/dev/null; then
    run_if_installed ldconfig
fi

# Run depmod if kernel modules were installed
if grep -qE "lib/modules/.*/.*\.ko" "$dbdir/files" 2>/dev/null; then
    run_if_installed depmod -a
fi

# Restart services if package defines them and we're doing a system install
if [ "$root" = "/" ]; then
    services=$(get_pkg_services "$pkgname" 2>/dev/null)
    if [ -n "$services" ]; then
        for svc in $services; do
            restart_service "$svc"
        done
    fi
fi

info "installed $pkgname $version"
