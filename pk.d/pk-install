#!/bin/sh
# pk-install - install a package archive
# Usage: pk install <pk.tar.xz>

SCRIPT_DIR="$(dirname "$0")"
. "$SCRIPT_DIR/pk-common"

safety_check

[ $# -ge 1 ] || die "usage: pk install <pk.tar.xz>"

archive="$1"
[ -f "$archive" ] || die "file not found: $archive"

set -- $(parse_pkgname "$archive")
pkgname="$1"
version="$2"
[ -n "$pkgname" ] || die "cannot parse package name"

dbdir="$DB_DIR/$pkgname"
mkdir -p "$dbdir"

# Extract to root (defaults to / for chroot/native use)
root="${PK_ROOT:-/}"

# List files in archive
tar -tf "$archive" > "$dbdir/files"

# Extract archive
tar -xf "$archive" -C "$root"

# Record package info
printf '%s\n%s\n' "$pkgname" "$version" > "$dbdir/info"

info "installed $pkgname $version"
