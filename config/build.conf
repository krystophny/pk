# LFS Build Configuration
# Aggressive optimizations for maximum performance

# =============================================================================
# CPU Detection and Parallelism
# =============================================================================

# Auto-detect number of CPU cores
NPROC=$(nproc)
MAKEFLAGS="-j${NPROC}"
NINJA_STATUS="[%f/%t] "

# =============================================================================
# Aggressive Optimization Flags
# =============================================================================

# Base optimization level
OPT_LEVEL="-O3"

# CPU-specific tuning
# For Ryzen 9 5950X (Zen 3): znver3 enables all Zen 3 specific optimizations
# -march=native auto-detects, but explicit znver3 ensures consistency
ARCH_FLAGS="-march=znver3 -mtune=znver3"

# Fast math (breaks strict IEEE compliance for speed)
MATH_FLAGS="-ffast-math -fno-math-errno -ffinite-math-only -fno-signed-zeros -fno-trapping-math -fassociative-math -freciprocal-math"

# Link-Time Optimization
LTO_FLAGS="-flto=${NPROC} -fuse-linker-plugin"

# Additional aggressive optimizations
# Note: -floop-nest-optimize requires ISL library at GCC build time (not available)
AGGRESSIVE_FLAGS="-funroll-loops -fprefetch-loop-arrays -fomit-frame-pointer -fmerge-all-constants -fmodulo-sched -fmodulo-sched-allow-regmoves -fgcse-sm -fgcse-las -fipa-pta -fdevirtualize-at-ltrans -ftree-loop-distribution -ftree-loop-im -ftree-loop-ivcanon"

# Vectorization
VECTOR_FLAGS="-ftree-vectorize -fvect-cost-model=dynamic"

# Profile-guided optimization (for second pass builds)
# PGO_GEN_FLAGS="-fprofile-generate"
# PGO_USE_FLAGS="-fprofile-use -fprofile-correction"

# =============================================================================
# Combined Flag Sets
# =============================================================================

# Standard high-performance build
CFLAGS_PERF="${OPT_LEVEL} ${ARCH_FLAGS} ${MATH_FLAGS} ${LTO_FLAGS} ${AGGRESSIVE_FLAGS} ${VECTOR_FLAGS}"
CXXFLAGS_PERF="${CFLAGS_PERF}"

# Safe high-performance (no fast-math, for libraries that need IEEE compliance)
CFLAGS_SAFE="${OPT_LEVEL} ${ARCH_FLAGS} ${LTO_FLAGS} ${AGGRESSIVE_FLAGS} ${VECTOR_FLAGS}"
CXXFLAGS_SAFE="${CFLAGS_SAFE}"

# For toolchain bootstrap (more conservative)
CFLAGS_BOOTSTRAP="-O2 -march=native -mtune=native -pipe"
CXXFLAGS_BOOTSTRAP="${CFLAGS_BOOTSTRAP}"

# =============================================================================
# Linker Flags
# =============================================================================

# Use gold or mold linker if available for faster linking
LDFLAGS_BASE="-Wl,-O2 -Wl,--as-needed -Wl,--sort-common"
LDFLAGS_LTO="-flto=${NPROC} -fuse-linker-plugin"

# Combined linker flags
LDFLAGS_PERF="${LDFLAGS_BASE} ${LDFLAGS_LTO}"

# =============================================================================
# Package-Specific Overrides
# =============================================================================

# GCC bootstrap needs special handling
GCC_BOOTSTRAP_FLAGS="-O2 -pipe"

# glibc should NOT use fast-math or aggressive LTO
GLIBC_CFLAGS="-O3 -march=native -mtune=native -pipe"

# Kernel uses its own optimization system
KERNEL_MAKE_FLAGS="KCFLAGS='-march=native -mtune=native' KCPPFLAGS='-march=native -mtune=native'"

# OpenSSL needs IEEE-compliant math
OPENSSL_CFLAGS="${CFLAGS_SAFE}"

# Python needs careful optimization
PYTHON_CFLAGS="${CFLAGS_SAFE} -fno-semantic-interposition"
PYTHON_LDFLAGS="-Wl,-O2 -fno-semantic-interposition"

# =============================================================================
# Environment Export
# =============================================================================

export_perf_flags() {
    export CFLAGS="${CFLAGS_PERF}"
    export CXXFLAGS="${CXXFLAGS_PERF}"
    export LDFLAGS="${LDFLAGS_PERF}"
    export MAKEFLAGS="-j${NPROC}"
}

export_safe_flags() {
    export CFLAGS="${CFLAGS_SAFE}"
    export CXXFLAGS="${CXXFLAGS_SAFE}"
    export LDFLAGS="${LDFLAGS_PERF}"
    export MAKEFLAGS="-j${NPROC}"
}

export_bootstrap_flags() {
    export CFLAGS="${CFLAGS_BOOTSTRAP}"
    export CXXFLAGS="${CXXFLAGS_BOOTSTRAP}"
    export LDFLAGS="${LDFLAGS_BASE}"
    export MAKEFLAGS="-j${NPROC}"
}

# =============================================================================
# Build System Detection
# =============================================================================

# Prefer mold > lld > gold > bfd for linking speed
detect_linker() {
    if command -v mold >/dev/null 2>&1; then
        echo "-fuse-ld=mold"
    elif command -v ld.lld >/dev/null 2>&1; then
        echo "-fuse-ld=lld"
    elif command -v ld.gold >/dev/null 2>&1; then
        echo "-fuse-ld=gold"
    else
        echo ""
    fi
}

# Add linker selection to LDFLAGS
LINKER_FLAG=$(detect_linker)
if [ -n "${LINKER_FLAG}" ]; then
    LDFLAGS_PERF="${LDFLAGS_PERF} ${LINKER_FLAG}"
fi
