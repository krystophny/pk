[packages.dosfstools]
version = "4.2"
version_check = "github:dosfstools/dosfstools"
description = "FAT filesystem utilities (mkfs.fat, fsck.fat)"
url = "https://github.com/dosfstools/dosfstools/releases/download/v${version}/dosfstools-${version}.tar.gz"
stage = 3
build_system = "autotools"
configure_flags = "--enable-compat-symlinks"
provides = ["/usr/sbin/mkfs.fat", "/usr/sbin/mkfs.vfat"]

[packages.desktop-file-utils]
version = "0.28"
version_check = "freedesktop:xdg/desktop-file-utils"
description = "Utilities for .desktop files"
url = "https://www.freedesktop.org/software/desktop-file-utils/releases/desktop-file-utils-${version}.tar.xz"
git_url = "https://gitlab.freedesktop.org/xdg/desktop-file-utils.git"
use_git = false
stage = 8
build_system = "meson"
depends = ["glib"]
provides = ["/usr/bin/update-desktop-database"]

[packages.diffutils]
version = "3.12"
version_check = "gnu:diffutils"
description = "GNU diff utilities"
url = "https://ftpmirror.gnu.org/gnu/diffutils/diffutils-${version}.tar.xz"
git_url = "https://git.savannah.gnu.org/git/diffutils.git"
use_git = false
stage = 2
provides = ["${SYSROOT}/usr/bin/diff"]
build_commands = [
    "./configure --prefix=/usr --host=${TARGET} --build=$(./config.guess) gl_cv_func_strcasecmp_works=yes",
    "make -j${NPROC}",
    "make DESTDIR=${PKG} install"
]

[packages.dhcpcd]
version = "10.3.0"
version_check = "github:NetworkConfiguration/dhcpcd"
description = "DHCP client daemon"
url = "https://github.com/NetworkConfiguration/dhcpcd/releases/download/v${version}/dhcpcd-${version}.tar.xz"
git_url = "https://github.com/NetworkConfiguration/dhcpcd.git"
use_git = false
stage = 7
services = ["dhcpcd"]

[packages.duktape]
version = "2.7.0"
version_check = "github:nicholasdechiara/duktape"
description = "Embeddable JavaScript engine"
url = "https://duktape.org/duktape-${version}.tar.xz"
use_git = false
stage = 8
# Duktape refuses -ffast-math, use safe flags
build_commands = [
    "make -f Makefile.sharedlibrary INSTALL_PREFIX=/usr CFLAGS='-O3 -march=znver3 -mtune=znver3 -fPIC'",
    "make -f Makefile.sharedlibrary INSTALL_PREFIX=/usr DESTDIR=${PKG} install",
    "install -Dm644 src/duktape.h ${PKG}/usr/include/duktape.h",
    "install -Dm644 src/duk_config.h ${PKG}/usr/include/duk_config.h"
]

# STAGE 9: GTK and Desktop Libraries

[packages.dbus]
version = "1.16.2"
version_check = "freedesktop:dbus/dbus"
description = "Message bus system"
url = "https://dbus.freedesktop.org/releases/dbus/dbus-${version}.tar.xz"
git_url = "https://gitlab.freedesktop.org/dbus/dbus.git"
use_git = false
stage = 4
build_order = 50
depends = ["expat", "meson", "glib"]
build_commands = [
    "meson setup build --prefix=/usr --sysconfdir=/etc --localstatedir=/var --buildtype=release -Druntime_dir=/run -Dsystem_socket=/run/dbus/system_bus_socket -Ddoxygen_docs=disabled -Dxml_docs=disabled -Dsystemd=disabled -Dapparmor=disabled -Dselinux=disabled",
    "meson compile -C build",
    "DESTDIR=${PKG} meson install -C build"
]
services = ["dbus"]

[packages.dejavu-fonts]
version = "2.37"
version_check = "url:https://github.com/dejavu-fonts/dejavu-fonts/releases|version_([0-9]+)_([0-9]+)"
description = "DejaVu TrueType fonts"
url = "https://github.com/dejavu-fonts/dejavu-fonts/releases/download/version_2_37/dejavu-fonts-ttf-${version}.tar.bz2"
source_dir = "dejavu-fonts-ttf-${version}"
stage = 8
build_order = 3
build_commands = [
    "mkdir -p ${PKG}/usr/share/fonts/dejavu",
    "install -m644 ttf/*.ttf ${PKG}/usr/share/fonts/dejavu/"
]
provides = ["/usr/share/fonts/dejavu/DejaVuSans.ttf"]

[packages.docbook-xml]
version = "4.5"
version_check = "url:https://docbook.org/xml/|([0-9]+\\.[0-9]+)/"
description = "DocBook XML DTDs"
url = "https://archive.docbook.org/xml/${version}/docbook-xml-${version}.zip"
stage = 4
# ZIP file extracts files directly, not into a directory - use python to extract
build_commands = [
    "mkdir -p /usr/src/docbook-xml-${version} && cd /usr/src/docbook-xml-${version} && python3 -m zipfile -e /usr/src/docbook-xml-${version}.zip .",
    "cd /usr/src/docbook-xml-${version} && mkdir -p ${PKG}/usr/share/xml/docbook/xml-dtd-${version}",
    "cd /usr/src/docbook-xml-${version} && cp -af docbook.cat *.dtd ent *.mod ${PKG}/usr/share/xml/docbook/xml-dtd-${version}/",
    "mkdir -p ${PKG}/etc/xml",
    "xmlcatalog --noout --create ${PKG}/etc/xml/docbook",
    "xmlcatalog --noout --add 'public' '-//OASIS//DTD DocBook XML V${version}//EN' 'http://www.oasis-open.org/docbook/xml/${version}/docbookx.dtd' ${PKG}/etc/xml/docbook",
    "xmlcatalog --noout --add 'system' 'http://www.oasis-open.org/docbook/xml/${version}/docbookx.dtd' 'file:///usr/share/xml/docbook/xml-dtd-${version}/docbookx.dtd' ${PKG}/etc/xml/docbook",
    "xmlcatalog --noout --add 'rewriteSystem' 'http://www.oasis-open.org/docbook/xml/${version}' 'file:///usr/share/xml/docbook/xml-dtd-${version}' ${PKG}/etc/xml/docbook",
    "xmlcatalog --noout --add 'rewriteURI' 'http://www.oasis-open.org/docbook/xml/${version}' 'file:///usr/share/xml/docbook/xml-dtd-${version}' ${PKG}/etc/xml/docbook"
]
depends = ["libxml2"]
provides = ["/usr/share/xml/docbook/xml-dtd-4.5/docbookx.dtd"]

[packages.docbook-xsl]
version = "1.79.2"
version_check = "github:docbook/xslt10-stylesheets"
description = "DocBook XSL stylesheets"
url = "https://github.com/docbook/xslt10-stylesheets/releases/download/release/${version}/docbook-xsl-nons-${version}.tar.bz2"
source_dir = "docbook-xsl-nons-${version}"
stage = 4
build_commands = [
    "mkdir -p ${PKG}/usr/share/xml/docbook/xsl-stylesheets-${version}",
    "cp -af VERSION* assembly common eclipse epub epub3 extensions fo highlighting html htmlhelp images javahelp lib manpages params profiling roundtrip slides template tools webhelp website xhtml xhtml-1_1 xhtml5 ${PKG}/usr/share/xml/docbook/xsl-stylesheets-${version}/ 2>/dev/null || true",
    "mkdir -p ${PKG}/etc/xml",
    "test -f ${PKG}/etc/xml/catalog || xmlcatalog --noout --create ${PKG}/etc/xml/catalog",
    "xmlcatalog --noout --add 'rewriteSystem' 'http://docbook.sourceforge.net/release/xsl/${version}' 'file:///usr/share/xml/docbook/xsl-stylesheets-${version}' ${PKG}/etc/xml/catalog",
    "xmlcatalog --noout --add 'rewriteURI' 'http://docbook.sourceforge.net/release/xsl/${version}' 'file:///usr/share/xml/docbook/xsl-stylesheets-${version}' ${PKG}/etc/xml/catalog",
    "xmlcatalog --noout --add 'rewriteSystem' 'http://docbook.sourceforge.net/release/xsl/current' 'file:///usr/share/xml/docbook/xsl-stylesheets-${version}' ${PKG}/etc/xml/catalog",
    "xmlcatalog --noout --add 'rewriteURI' 'http://docbook.sourceforge.net/release/xsl/current' 'file:///usr/share/xml/docbook/xsl-stylesheets-${version}' ${PKG}/etc/xml/catalog"
]
depends = ["libxslt", "docbook-xml"]
provides = ["/usr/share/xml/docbook/xsl-stylesheets-1.79.2/html/docbook.xsl"]

[packages.dejagnu]
version = "1.6.3"
version_check = "gnu:dejagnu"
description = "GNU testing framework"
url = "https://ftpmirror.gnu.org/gnu/dejagnu/dejagnu-${version}.tar.gz"
stage = 10
depends = ["tcl", "expect"]
build_commands = [
    "./configure --prefix=/usr",
    "make",
    "make DESTDIR=${PKG} install"
]
provides = ["/usr/bin/runtest"]

[packages.dxvk]
version = "2.7.1"
version_check = "github:doitsujin/dxvk"
description = "Vulkan-based D3D9/D3D10/D3D11 translation"
url = "https://github.com/doitsujin/dxvk/releases/download/v${version}/dxvk-${version}.tar.gz"
git_url = "https://github.com/doitsujin/dxvk.git"
use_git = false
stage = 13
