[packages.ncurses]
version = "6.6"
version_check = "gnu:ncurses"
description = "Terminal handling library"
url = "https://ftpmirror.gnu.org/gnu/ncurses/ncurses-${version}.tar.gz"
git_url = "https://github.com/mirror/ncurses.git"
use_git = false
stage = 2
provides = ["${SYSROOT}/usr/lib/libncursesw.so"]
build_commands = [
    "mkdir -p build && pushd build && ../configure AWK=gawk && make -C include && make -C progs tic && popd",
    "./configure --prefix=/usr --host=${TARGET} --build=$(./config.guess) --mandir=/usr/share/man --with-manpage-format=normal --with-shared --without-normal --without-cxx-binding --without-debug --without-ada --disable-stripping",
    "make -j${NPROC}",
    "make DESTDIR=${PKG} TIC_PATH=$(pwd)/build/progs/tic install",
    "ln -svf libncursesw.so ${PKG}/usr/lib/libncurses.so",
    "sed -e 's/^#if.*XOPEN.*$/#if 1/' -i ${PKG}/usr/include/curses.h"
]

# Stage 3: rebuild ncurses natively with pkg-config support

[packages.ncurses-stage3]
version = "6.6"
version_check = "gnu:ncurses"
description = "Terminal handling library (native build)"
url = "https://ftpmirror.gnu.org/gnu/ncurses/ncurses-${version}.tar.gz"
tarball = "ncurses-${version}.tar.gz"
stage = 3
build_order = 30
build_commands = [
    "./configure --prefix=/usr --mandir=/usr/share/man --with-shared --without-debug --without-normal --without-cxx-binding --with-abi-version=6 --enable-widec --enable-pc-files --with-pkg-config-libdir=/usr/lib/pkgconfig",
    "make -j${NPROC}",
    "make DESTDIR=${PKG} install",
    "for lib in ncurses form panel menu; do ln -svf lib${lib}w.so ${PKG}/usr/lib/lib${lib}.so; ln -svf ${lib}w.pc ${PKG}/usr/lib/pkgconfig/${lib}.pc; done",
    "ln -svf libncursesw.so ${PKG}/usr/lib/libcursesw.so",
    "ln -svf libncurses.so ${PKG}/usr/lib/libcurses.so"
]

[packages.nettle]
version = "3.10.2"
version_check = "gnu:nettle"
description = "Low-level cryptographic library"
url = "https://ftpmirror.gnu.org/gnu/nettle/nettle-${version}.tar.gz"
git_url = "https://git.lysator.liu.se/nettle/nettle.git"
use_git = false
stage = 4
build_order = 4
configure_flags = "--disable-static"
depends = ["gmp"]

[packages.newlib]
version = "4.6.0.20260123"
version_check = "url:ftp://sourceware.org/pub/newlib/|newlib-([0-9.]+)\\.tar\\.gz"
description = "C library for embedded systems (used for nvptx offloading)"
url = "ftp://sourceware.org/pub/newlib/newlib-${version}.tar.gz"
stage = 3
build_order = 24
# Built as part of GCC nvptx offload, not standalone

[packages.newlib-riscv-elf]
version = "4.6.0.20260123"
version_check = "url:ftp://sourceware.org/pub/newlib/|newlib-([0-9.]+)\\.tar\\.gz"
description = "Newlib C library for RISC-V bare-metal"
url = "ftp://sourceware.org/pub/newlib/newlib-${version}.tar.gz"
tarball = "newlib-${version}.tar.gz"
source_dir = "newlib-${version}"
stage = 15
depends = ["binutils-riscv-elf"]
skip_optimization = true
build_commands = [
    "mkdir -p ${srcdir}/build-riscv && cd ${srcdir}/build-riscv && ${srcdir}/configure --prefix=/usr --target=riscv64-elf --disable-newlib-supplied-syscalls --enable-newlib-io-long-long --enable-newlib-io-c99-formats --enable-newlib-mb --enable-newlib-reent-check-verify",
    "cd ${srcdir}/build-riscv && make -j${NPROC}",
    "cd ${srcdir}/build-riscv && make DESTDIR=${PKG} install"
]
provides = ["/usr/riscv64-elf/lib/libc.a"]

[packages.nvptx-tools]
version = "0.20240810"
version_check = "github:SourceryTools/nvptx-tools"
description = "Assembler and linker for NVIDIA PTX (GCC offloading)"
url = "https://github.com/SourceryTools/nvptx-tools/archive/refs/heads/master.tar.gz"
git_url = "https://github.com/SourceryTools/nvptx-tools.git"
use_git = true
stage = 3
build_order = 24
# Disable LTO - libiberty doesn't link properly with it
skip_optimization = true
build_commands = [
    "./configure --prefix=/usr CFLAGS='-O2 -march=znver3' CXXFLAGS='-O2 -march=znver3' LDFLAGS=''",
    "make -j${NPROC}",
    "make DESTDIR=${PKG} install"
]
provides = ["/usr/bin/nvptx-as"]

[packages.ninja]
version = "1.13.2"
version_check = "github:ninja-build/ninja"
description = "Small build system with focus on speed"
url = "https://github.com/ninja-build/ninja/archive/refs/tags/v${version}.tar.gz"
git_url = "https://github.com/ninja-build/ninja.git"
use_git = false
stage = 4
build_order = 6
build_commands = [
    "python3 configure.py --bootstrap",
    "install -Dm755 ninja ${PKG}/usr/bin/ninja"
]

# FPGA/EDA Tools

[packages.nextpnr]
version = "0.9"
version_check = "github:YosysHQ/nextpnr"
description = "Portable FPGA place and route tool (iCE40, ECP5, Gowin)"
url = "https://github.com/YosysHQ/nextpnr/archive/refs/tags/nextpnr-${version}.tar.gz"
git_url = "https://github.com/YosysHQ/nextpnr.git"
use_git = false
source_dir = "nextpnr-nextpnr-${version}"
stage = 15
depends = ["icestorm", "python", "boost", "eigen"]
build_system = "cmake"
cmake_flags = "-DARCH=ice40 -DICESTORM_INSTALL_PREFIX=/usr -DBUILD_GUI=OFF"
provides = ["/usr/bin/nextpnr-ice40"]

[packages.nextcloud-client]
version = "4.0.6"
version_check = "github:nextcloud/desktop"
description = "Nextcloud desktop sync client"
url = "https://github.com/nextcloud/desktop/archive/refs/tags/v${version}.tar.gz"
git_url = "https://github.com/nextcloud/desktop.git"
use_git = false
stage = 11
repology = "nextcloud-client"

# STAGE 12: GPU Drivers
# NVIDIA open-source kernel modules (recommended by upstream)
# Use nvidia-open for production, nvidia-open-latest for bleeding edge

[packages.nvidia-open]
version = "590.48.01"
version_check = "github:NVIDIA/open-gpu-kernel-modules"
description = "NVIDIA open kernel modules + userspace (590 for Turing+)"
url = "https://github.com/NVIDIA/open-gpu-kernel-modules/archive/refs/tags/${version}.tar.gz"
source_dir = "open-gpu-kernel-modules-${version}"
stage = 12
depends = ["linux"]
extra_sources = ["https://download.nvidia.com/XFree86/Linux-x86_64/${version}/NVIDIA-Linux-x86_64-${version}.run"]
skip_optimization = true
build_commands = [
    # Clean any previous userspace extraction
    "rm -rf userspace",
    # Build open kernel modules from source (unset LDFLAGS to avoid kernel LTO flags)
    "unset LDFLAGS; make -j${NPROC} SYSSRC=/lib/modules/$(uname -r)/build NV_VERBOSE=1 modules",
    # Extract userspace from .run file
    "chmod +x ${SOURCES_DIR}/NVIDIA-Linux-x86_64-${version}.run",
    "${SOURCES_DIR}/NVIDIA-Linux-x86_64-${version}.run --extract-only --target userspace",
    # Install kernel modules (use /lib/modules, not /usr/lib/modules)
    "mkdir -p ${PKG}/lib/modules/$(uname -r)/kernel/drivers/video",
    "install -m644 kernel-open/*.ko ${PKG}/lib/modules/$(uname -r)/kernel/drivers/video/",
    # Install userspace libraries
    "mkdir -p ${PKG}/usr/lib ${PKG}/usr/lib/xorg/modules/drivers ${PKG}/usr/lib/xorg/modules/extensions",
    "mkdir -p ${PKG}/usr/bin ${PKG}/usr/share/glvnd/egl_vendor.d ${PKG}/etc/OpenCL/vendors",
    "mkdir -p ${PKG}/usr/share/vulkan/icd.d ${PKG}/etc/X11/xorg.conf.d ${PKG}/usr/share/nvidia",
    "mkdir -p ${PKG}/lib/firmware/nvidia/${version}",
    # Install GLVND vendor libraries (NOT the thin wrappers like libGL.so, libEGL.so - those come from mesa)
    "install -m755 userspace/libGLX_nvidia.so.${version} userspace/libEGL_nvidia.so.${version} ${PKG}/usr/lib/",
    "install -m755 userspace/libcuda*.so.${version} userspace/libnvcuvid.so.${version} ${PKG}/usr/lib/ || true",
    "install -m755 userspace/libnvidia*.so.${version} ${PKG}/usr/lib/",
    "install -m755 userspace/nvidia_drv.so ${PKG}/usr/lib/xorg/modules/drivers/",
    "install -m755 userspace/libglxserver_nvidia.so.${version} ${PKG}/usr/lib/xorg/modules/extensions/",
    "ln -sf libglxserver_nvidia.so.${version} ${PKG}/usr/lib/xorg/modules/extensions/libglxserver_nvidia.so",
    "install -m755 userspace/nvidia-smi userspace/nvidia-xconfig ${PKG}/usr/bin/",
    "install -m755 userspace/nvidia-settings ${PKG}/usr/bin/ || true",
    "install -m644 userspace/10_nvidia.json ${PKG}/usr/share/glvnd/egl_vendor.d/",
    "install -m644 userspace/nvidia.icd ${PKG}/etc/OpenCL/vendors/",
    "install -m644 userspace/nvidia_icd.json ${PKG}/usr/share/vulkan/icd.d/",
    "install -m644 userspace/firmware/*.bin ${PKG}/lib/firmware/nvidia/${version}/ || true",
    # Create library symlinks for nvidia libs (.so and .so.1)
    "find ${PKG}/usr/lib -maxdepth 1 -name 'libnvidia*.so.${version}' -exec sh -c 'for f; do b=$(basename $f); ln -sf $b ${f%.${version}}; ln -sf $b ${f%.so.${version}}.so.1; done' _ {} +",
    "find ${PKG}/usr/lib -maxdepth 1 -name 'libcuda*.so.${version}' -exec sh -c 'for f; do b=$(basename $f); ln -sf $b ${f%.${version}}; ln -sf $b ${f%.so.${version}}.so.1; done' _ {} +",
    "find ${PKG}/usr/lib -maxdepth 1 -name 'libnvcuvid*.so.${version}' -exec sh -c 'for f; do b=$(basename $f); ln -sf $b ${f%.${version}}; ln -sf $b ${f%.so.${version}}.so.1; done' _ {} +",
    # Create GLVND vendor library symlinks (.so, .so.0, and .so.1)
    "ln -sf libGLX_nvidia.so.${version} ${PKG}/usr/lib/libGLX_nvidia.so",
    "ln -sf libGLX_nvidia.so.${version} ${PKG}/usr/lib/libGLX_nvidia.so.0",
    "ln -sf libGLX_nvidia.so.${version} ${PKG}/usr/lib/libGLX_nvidia.so.1",
    "ln -sf libEGL_nvidia.so.${version} ${PKG}/usr/lib/libEGL_nvidia.so",
    "ln -sf libEGL_nvidia.so.${version} ${PKG}/usr/lib/libEGL_nvidia.so.0",
    "ln -sf libEGL_nvidia.so.${version} ${PKG}/usr/lib/libEGL_nvidia.so.1",
    # X11 config for nvidia driver
    "printf 'Section \"Device\"\\n    Identifier \"NVIDIA\"\\n    Driver \"nvidia\"\\n    Option \"AllowEmptyInitialConfiguration\"\\nEndSection\\n' > ${PKG}/etc/X11/xorg.conf.d/20-nvidia.conf",
    # udev rules for nvidia device nodes
    "mkdir -p ${PKG}/usr/lib/udev/rules.d",
    "printf 'KERNEL==\"nvidia\", RUN+=\"/usr/bin/nvidia-modprobe -c 0 -u\"\\nKERNEL==\"nvidia_uvm\", RUN+=\"/usr/bin/nvidia-modprobe -c 0 -u\"\\n' > ${PKG}/usr/lib/udev/rules.d/70-nvidia.rules",
    # Install nvidia-modprobe for device node creation
    "install -m4755 userspace/nvidia-modprobe ${PKG}/usr/bin/ || true",
    # modprobe config for nvidia-drm modeset
    "mkdir -p ${PKG}/etc/modprobe.d",
    "echo 'options nvidia-drm modeset=1' > ${PKG}/etc/modprobe.d/nvidia-drm.conf",
    # Auto-load nvidia-drm on boot
    "mkdir -p ${PKG}/etc/modules-load.d",
    "echo 'nvidia-drm' > ${PKG}/etc/modules-load.d/nvidia.conf"
]
provides = ["/usr/lib/libnvidia-glcore.so.${version}", "/usr/bin/nvidia-smi"]

[packages.nodejs]
version = "25.4.0"
version_check = "github:nodejs/node"
description = "JavaScript runtime"
url = "https://nodejs.org/dist/v${version}/node-v${version}.tar.xz"
git_url = "https://github.com/nodejs/node.git"
use_git = false
stage = 14

[packages.nspr]
version = "4.38.2"
version_check = "url:https://archive.mozilla.org/pub/nspr/releases/|v([0-9]+\\.[0-9]+\\.?[0-9]*)/src"
description = "Netscape Portable Runtime"
url = "https://archive.mozilla.org/pub/nspr/releases/v${version}/src/nspr-${version}.tar.gz"
stage = 4
build_order = 10
build_commands = [
    "(cd nspr && ./configure --prefix=/usr --with-mozilla --with-pthreads --enable-64bit)",
    "(cd nspr && make -j${NPROC})",
    "(cd nspr && make DESTDIR=${PKG} install)"
]
provides = ["/usr/lib/libnspr4.so"]

[packages.nss]
version = "3.120"
version_check = "url:https://archive.mozilla.org/pub/security/nss/releases/|NSS_([0-9]+)_([0-9]+)_RTM"
description = "Network Security Services"
url = "https://archive.mozilla.org/pub/security/nss/releases/NSS_3_120_RTM/src/nss-${version}.tar.gz"
stage = 4
build_order = 11
depends = ["nspr", "sqlite"]
build_commands = [
    "(cd nss && make -j${NPROC} BUILD_OPT=1 NSPR_INCLUDE_DIR=/usr/include/nspr NSPR_LIB_DIR=/usr/lib USE_SYSTEM_ZLIB=1 ZLIB_LIBS=-lz NSS_USE_SYSTEM_SQLITE=1 NSS_ENABLE_WERROR=0 NSS_DISABLE_GTESTS=1 USE_64=1)",
    "mkdir -p ${PKG}/usr/lib/pkgconfig ${PKG}/usr/include/nss ${PKG}/usr/bin",
    "NSS_DIST=$(ls -d dist/*_OPT.OBJ); install -m755 $NSS_DIST/lib/*.so ${PKG}/usr/lib/",
    "NSS_DIST=$(ls -d dist/*_OPT.OBJ); install -m644 $NSS_DIST/lib/*.chk ${PKG}/usr/lib/ || true",
    "install -m644 dist/public/nss/*.h ${PKG}/usr/include/nss/",
    "NSS_DIST=$(ls -d dist/*_OPT.OBJ); install -m755 $NSS_DIST/bin/certutil $NSS_DIST/bin/pk12util ${PKG}/usr/bin/"
]
provides = ["/usr/lib/libnss3.so"]

[packages.nv-codec-headers]
version = "13.0.19.0"
version_check = "github:FFmpeg/nv-codec-headers"
description = "NVIDIA codec headers for FFmpeg"
url = "https://github.com/FFmpeg/nv-codec-headers/releases/download/n${version}/nv-codec-headers-${version}.tar.gz"
stage = 16
build_order = 5
build_commands = [
    "make PREFIX=/usr DESTDIR=${PKG} install"
]
provides = ["/usr/include/ffnvcodec/nvEncodeAPI.h", "/usr/lib/pkgconfig/ffnvcodec.pc"]

[packages.nvidia-vaapi-driver]
version = "0.0.14"
version_check = "github:elFarto/nvidia-vaapi-driver"
description = "VA-API driver for NVIDIA GPUs"
url = "https://github.com/elFarto/nvidia-vaapi-driver/archive/refs/tags/v${version}.tar.gz"
stage = 16
build_order = 30
depends = ["libva", "nv-codec-headers", "libdrm", "gst-plugins-bad", "nvidia-open"]
build_system = "meson"
build_commands = [
    "mkdir -p ${PKG}/etc/profile.d",
    "meson setup build --prefix=/usr",
    "meson compile -C build",
    "DESTDIR=${PKG} meson install -C build",
    "echo 'export LIBVA_DRIVER_NAME=nvidia' > ${PKG}/etc/profile.d/nvidia-vaapi.sh",
    "echo 'export MOZ_DISABLE_RDD_SANDBOX=1' >> ${PKG}/etc/profile.d/nvidia-vaapi.sh",
    "echo 'export NVD_BACKEND=direct' >> ${PKG}/etc/profile.d/nvidia-vaapi.sh"
]
provides = ["/usr/lib/dri/nvidia_drv_video.so", "/etc/profile.d/nvidia-vaapi.sh"]

[packages.nvme-cli]
version = "2.16"
version_check = "github:linux-nvme/nvme-cli"
description = "NVMe management command line interface"
url = "https://github.com/linux-nvme/nvme-cli/archive/v${version}/nvme-cli-${version}.tar.gz"
git_url = "https://github.com/linux-nvme/nvme-cli.git"
use_git = false
stage = 19
# For Samsung NVMe PM9A1/980PRO management

# Software RAID
