[packages.ncurses]
version = "6.6"
version_check = "gnu:ncurses"
description = "Terminal handling library"
url = "https://ftpmirror.gnu.org/gnu/ncurses/ncurses-${version}.tar.gz"
git_url = "https://github.com/mirror/ncurses.git"
use_git = false
stage = 2
provides = ["${SYSROOT}/usr/lib/libncursesw.so"]
build_commands = [
    "mkdir -p build && pushd build && ../configure AWK=gawk && make -C include && make -C progs tic && popd",
    "./configure --prefix=/usr --host=${TARGET} --build=$(./config.guess) --mandir=/usr/share/man --with-manpage-format=normal --with-shared --without-normal --without-cxx-binding --without-debug --without-ada --disable-stripping",
    "make -j${NPROC}",
    "make DESTDIR=${PKG} TIC_PATH=$(pwd)/build/progs/tic install",
    "ln -svf libncursesw.so ${PKG}/usr/lib/libncurses.so",
    "sed -e 's/^#if.*XOPEN.*$/#if 1/' -i ${PKG}/usr/include/curses.h"
]

# Stage 3: rebuild ncurses natively with pkg-config support

[packages.ncurses-stage3]
version = "6.6"
version_check = "gnu:ncurses"
description = "Terminal handling library (native build)"
url = "https://ftpmirror.gnu.org/gnu/ncurses/ncurses-${version}.tar.gz"
tarball = "ncurses-${version}.tar.gz"
stage = 3
build_order = 30
build_commands = [
    "./configure --prefix=/usr --mandir=/usr/share/man --with-shared --without-debug --without-normal --without-cxx-binding --with-abi-version=6 --enable-widec --enable-pc-files --with-pkg-config-libdir=/usr/lib/pkgconfig",
    "make -j${NPROC}",
    "make DESTDIR=${PKG} install",
    "for lib in ncurses form panel menu; do ln -svf lib${lib}w.so ${PKG}/usr/lib/lib${lib}.so; ln -svf ${lib}w.pc ${PKG}/usr/lib/pkgconfig/${lib}.pc; done",
    "ln -svf libncursesw.so ${PKG}/usr/lib/libcursesw.so",
    "ln -svf libncurses.so ${PKG}/usr/lib/libcurses.so"
]

[packages.nettle]
version = "3.10.2"
version_check = "gnu:nettle"
description = "Low-level cryptographic library"
url = "https://ftpmirror.gnu.org/gnu/nettle/nettle-${version}.tar.gz"
git_url = "https://git.lysator.liu.se/nettle/nettle.git"
use_git = false
stage = 4
build_order = 4
configure_flags = "--disable-static"
depends = ["gmp"]

[packages.newlib]
version = "4.6.0.20260123"
version_check = "url:ftp://sourceware.org/pub/newlib/|newlib-([0-9.]+)\\.tar\\.gz"
description = "C library for embedded systems (used for nvptx offloading)"
url = "ftp://sourceware.org/pub/newlib/newlib-${version}.tar.gz"
stage = 3
build_order = 24
# Built as part of GCC nvptx offload, not standalone

[packages.nvptx-tools]
version = "0.1"
version_check = "github:SourceryTools/nvptx-tools"
description = "Assembler and linker for NVIDIA PTX (GCC offloading)"
url = "https://github.com/SourceryTools/nvptx-tools/archive/refs/heads/master.tar.gz"
git_url = "https://github.com/SourceryTools/nvptx-tools.git"
use_git = true
stage = 3
build_order = 24
# Disable LTO - libiberty doesn't link properly with it
skip_optimization = true
build_commands = [
    "./configure --prefix=/usr CFLAGS='-O2 -march=znver3' CXXFLAGS='-O2 -march=znver3' LDFLAGS=''",
    "make -j${NPROC}",
    "make DESTDIR=${PKG} install"
]
provides = ["/usr/bin/nvptx-as"]

[packages.ninja]
version = "1.13.2"
version_check = "github:ninja-build/ninja"
description = "Small build system with focus on speed"
url = "https://github.com/ninja-build/ninja/archive/refs/tags/v${version}.tar.gz"
git_url = "https://github.com/ninja-build/ninja.git"
use_git = false
stage = 4
build_order = 6
build_commands = [
    "python3 configure.py --bootstrap",
    "install -Dm755 ninja ${PKG}/usr/bin/ninja"
]

[packages.nextcloud-client]
version = "4.0.6"
version_check = "github:nextcloud/desktop"
description = "Nextcloud desktop sync client"
url = "https://github.com/nextcloud/desktop/archive/refs/tags/v${version}.tar.gz"
git_url = "https://github.com/nextcloud/desktop.git"
use_git = false
stage = 11
repology = "nextcloud-client"

# STAGE 12: GPU Drivers
# NVIDIA open-source kernel modules (recommended by upstream)
# Use nvidia-open for production, nvidia-open-latest for bleeding edge

[packages.nvidia-open]
version = "570.211.01"
version_check = "github:NVIDIA/open-gpu-kernel-modules"
description = "NVIDIA open kernel modules + userspace (570 branch for Blackwell)"
url = "https://github.com/NVIDIA/open-gpu-kernel-modules/archive/refs/tags/${version}.tar.gz"
source_dir = "open-gpu-kernel-modules-${version}"
stage = 12
depends = ["linux"]
extra_sources = ["https://download.nvidia.com/XFree86/Linux-x86_64/${version}/NVIDIA-Linux-x86_64-${version}.run"]
skip_optimization = true
build_commands = [
    # Clean any previous userspace extraction
    "rm -rf userspace",
    # Build open kernel modules from source (unset LDFLAGS to avoid kernel LTO flags)
    "unset LDFLAGS; make -j${NPROC} SYSSRC=/lib/modules/$(uname -r)/build NV_VERBOSE=1 modules",
    # Extract userspace from .run file
    "chmod +x ${SOURCES_DIR}/NVIDIA-Linux-x86_64-${version}.run",
    "${SOURCES_DIR}/NVIDIA-Linux-x86_64-${version}.run --extract-only --target userspace",
    # Install kernel modules (use /lib/modules, not /usr/lib/modules)
    "mkdir -p ${PKG}/lib/modules/$(uname -r)/kernel/drivers/video",
    "install -m644 kernel-open/*.ko ${PKG}/lib/modules/$(uname -r)/kernel/drivers/video/",
    # Install userspace libraries
    "mkdir -p ${PKG}/usr/lib ${PKG}/usr/lib/xorg/modules/drivers ${PKG}/usr/lib/xorg/modules/extensions",
    "mkdir -p ${PKG}/usr/bin ${PKG}/usr/share/glvnd/egl_vendor.d ${PKG}/etc/OpenCL/vendors",
    "mkdir -p ${PKG}/usr/share/vulkan/icd.d ${PKG}/etc/X11/xorg.conf.d ${PKG}/usr/share/nvidia",
    "mkdir -p ${PKG}/lib/firmware/nvidia/${version}",
    "install -m755 userspace/libGL*.so.${version} userspace/libEGL*.so.${version} userspace/libGLESv*.so.${version} ${PKG}/usr/lib/ || true",
    "install -m755 userspace/libcuda*.so.${version} userspace/libnvcuvid.so.${version} ${PKG}/usr/lib/ || true",
    "install -m755 userspace/libnvidia*.so.${version} ${PKG}/usr/lib/",
    "install -m755 userspace/nvidia_drv.so ${PKG}/usr/lib/xorg/modules/drivers/",
    "install -m755 userspace/libglxserver_nvidia.so.${version} ${PKG}/usr/lib/xorg/modules/extensions/",
    "install -m755 userspace/nvidia-smi userspace/nvidia-xconfig ${PKG}/usr/bin/",
    "install -m755 userspace/nvidia-settings ${PKG}/usr/bin/ || true",
    "install -m644 userspace/10_nvidia.json ${PKG}/usr/share/glvnd/egl_vendor.d/",
    "install -m644 userspace/nvidia.icd ${PKG}/etc/OpenCL/vendors/",
    "install -m644 userspace/nvidia_icd.json ${PKG}/usr/share/vulkan/icd.d/",
    "install -m644 userspace/firmware/*.bin ${PKG}/lib/firmware/nvidia/${version}/ || true",
    # Create library symlinks (use find to avoid TOML escaping issues)
    "find ${PKG}/usr/lib -maxdepth 1 -name 'lib*.so.${version}' -exec sh -c 'for f; do b=$(basename $f); ln -sf $b ${f%.${version}}; ln -sf $b ${f%.so.${version}}.so.1; done' _ {} +",
    # X11 config for nvidia driver (use separate echos to avoid TOML escaping issues)
    "echo 'Section \"Device\"' > ${PKG}/etc/X11/xorg.conf.d/20-nvidia.conf",
    "echo '    Identifier \"NVIDIA\"' >> ${PKG}/etc/X11/xorg.conf.d/20-nvidia.conf",
    "echo '    Driver \"nvidia\"' >> ${PKG}/etc/X11/xorg.conf.d/20-nvidia.conf",
    "echo '    Option \"AllowEmptyInitialConfiguration\"' >> ${PKG}/etc/X11/xorg.conf.d/20-nvidia.conf",
    "echo 'EndSection' >> ${PKG}/etc/X11/xorg.conf.d/20-nvidia.conf",
    # udev rules for nvidia device nodes
    "mkdir -p ${PKG}/usr/lib/udev/rules.d",
    "echo 'KERNEL==\"nvidia\", RUN+=\"/usr/bin/nvidia-modprobe -c 0 -u\"' > ${PKG}/usr/lib/udev/rules.d/70-nvidia.rules",
    "echo 'KERNEL==\"nvidia_uvm\", RUN+=\"/usr/bin/nvidia-modprobe -c 0 -u\"' >> ${PKG}/usr/lib/udev/rules.d/70-nvidia.rules",
    # Install nvidia-modprobe for device node creation
    "install -m4755 userspace/nvidia-modprobe ${PKG}/usr/bin/ || true",
    # modprobe config for nvidia-drm modeset
    "mkdir -p ${PKG}/etc/modprobe.d",
    "echo 'options nvidia-drm modeset=1' > ${PKG}/etc/modprobe.d/nvidia-drm.conf",
    # Auto-load nvidia-drm on boot
    "mkdir -p ${PKG}/etc/modules-load.d",
    "echo 'nvidia-drm' > ${PKG}/etc/modules-load.d/nvidia.conf"
]
provides = ["/usr/lib/libnvidia-glcore.so.${version}", "/usr/bin/nvidia-smi"]

[packages.nodejs]
version = "25.4.0"
version_check = "github:nodejs/node"
description = "JavaScript runtime"
url = "https://nodejs.org/dist/v${version}/node-v${version}.tar.xz"
git_url = "https://github.com/nodejs/node.git"
use_git = false
stage = 14

# STAGE 15: HPC Compilers

[packages.nvhpc]
version = "100.630"
version_check = "url:https://developer.nvidia.com/hpc-sdk-downloads|([0-9]+\.[0-9]+)"
description = "NVIDIA HPC SDK (nvfortran, nvc, nvc++)"
# Manual download required from NVIDIA developer site
url = ""
git_url = ""
use_git = false
stage = 15
# Note: Binary distribution, install to /opt/nvidia/hpc_sdk
# Includes: nvfortran, nvc, nvc++, CUDA, cuBLAS, cuFFT, nvcc

[packages.nvme-cli]
version = "2.16"
version_check = "github:linux-nvme/nvme-cli"
description = "NVMe management command line interface"
url = "https://github.com/linux-nvme/nvme-cli/archive/v${version}/nvme-cli-${version}.tar.gz"
git_url = "https://github.com/linux-nvme/nvme-cli.git"
use_git = false
stage = 19
# For Samsung NVMe PM9A1/980PRO management

# Software RAID
